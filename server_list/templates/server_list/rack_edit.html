{% extends 'server_list/navbar.html' %}
{% block title %}Карточка стойки{% endblock %}
{% load server_list_extras %}
{% block script %}
{% include "server_list/js_open_window.html" %}
var territory_id = {{form.instance.room.territory.id|convert_none}}
var room_id = {{form.instance.room.id|convert_none}}
window.onload = function() {
    let sel = document.getElementById("id_territory");
    sel.onchange = function(){
        console.log('onchange');
        update_room_list(sel.options[sel.selectedIndex].value,null);
    }


    if (territory_id != null){
        for (var i = 0; i < sel.length; i++){
            console.log (i, territory_id, sel.options[i].value);
            if (sel.options[i].value == territory_id){
                sel.selectedIndex = i;
            }
        }
        update_room_list(territory_id,room_id);
    }else {
        empty_room_list();
    }
    let room_sel = document.getElementById("id_room");
    if (room_id != null){
        for (var i = 0; i < room_sel.length; i++){
            //console.log (i, territory_id, sel.options[i].value);
            if (room_sel.options[i].value == territory_id){
                room_sel.selectedIndex = i;
            }
        }
    }
    console.log('{{form.instance.room.id|convert_none}}');
}

function empty_room_list() {
    let sel = document.getElementById("id_room");
    sel.innerHTML = '';
    let opt = document.createElement('option');
    opt.innerHTML = '**сначала выберите территорию**';
    sel.appendChild(opt);
}
function update_room_list(ter_id,r_id){
    $.ajax({
        url: "{% url 'ajax' %}",
        type: 'GET',
        data: {'model':'room', 'territory':ter_id},
        dataType: "json",
        success: function(resp){
            $("#id_room").empty();
            $("#id_room").append($('<option></option>').attr('value', "").text('---------'));
            $.each(resp, function(idx, obj) {
                if(obj.pk==r_id){
                    $("#id_room").append($('<option></option>').attr('value', obj.pk).attr('selected','selected').text(obj.fields.name));
                }else{
                    $("#id_room").append($('<option></option>').attr('value', obj.pk).text(obj.fields.name));
                }
            });
        },
        error: function(jqXHR, textStatus, errorThrown) {
            alert(errorThrown+'ajax rooms');
        }
    });
}
function call_reload(caller, ids){
    update_room_list(territory_id, ids[0]);
}
{% endblock %}
{% block content %}


 <h6>Редактирование стойки</h6>
<form method="post">
    {%csrf_token%}
    {% for field in form %}
    <p>{{field.label}} {{field}}
        {% for error in field.errors %}
            {{error}}
        {% endfor %}
        {% if 'room' in field.name %}
        <a href="javascript:void(0);" onclick="if(/^\d+$/.test(document.getElementById('{{field.auto_id}}').value)) open_window('{% url 'room_edit_without_parameters' %}'+document.getElementById('{{field.auto_id}}').value+'?close=True', 'room_edit');">Редактировать</a>
        <a href="javascript:void(0);" onClick="open_window('{% url 'room_new' %}', 'room_add');">Добавить</a>
        {% endif %}
    </p>
    {% endfor %}
    <p><input type="submit" value="Submit"></p>
</form>

{% endblock %}