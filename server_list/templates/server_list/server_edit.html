<html xmlns:form.server_rack>
<head>
    <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
    <script>

{% load server_list_extras %}
{% load widget_tweaks %}
{% comment %}
{{form.server_territory.value}}
{{form.server_id}}
{% for f in form.fields_to_hide %}
    {{f}}
{% endfor %}
var territory_id={{data|get_dict_item:"territory"}};
var room_id={{data|get_dict_item:"room"}};
var rack_id={{data|get_dict_item:"rack"}};
{% endcomment %}



var territory_id={{form.server_territory.value|convert_none}};
var room_id={{form.server_room.value|convert_none}};
var rack_id={{form.server_rack.value|convert_none}};
var is_physical = {{form.is_physical.value|yesno:"true,false"}};
var vm_fields_to_hide = ["#id_server_unit", "#id_server_height", "#id_server_model","#id_server_serial_number","#id_server_territory", "#id_server_room", "#id_server_rack"]

console.log("{{form.server_name.value}}");
console.log(territory_id,room_id,rack_id, is_physical);
$(document).ready(function() {

    $.ajax({
        url: "{% url 'test_ajax' %}",
        type: 'GET',
        data: {'model': 'territory'},
        dataType: "json",
        success: function(resp){
            $("#id_server_territory").empty();
            $.each(resp, function(idx, obj) {
                if(obj.pk==territory_id){
                    $("#id_server_territory").append($('<option></option>').attr('value', obj.pk).attr('selected','selected').text(obj.fields.name));
                }else{
                    $("#id_server_territory").append($('<option></option>').attr('value', obj.pk).text(obj.fields.name));
                }
                });
            ajax_request_rooms_by_territory($("#id_server_territory").val());
        },
        error: function(jqXHR, textStatus, errorThrown) {
            alert(errorThrown+'initial load');
        }
    });

    $("#id_server_territory").change(function(){
        console.log('rack by room'+$("#id_server_territory").val());
        ajax_request_rooms_by_territory($("#id_server_territory").val());
    });

    $("#id_server_room").change(function(){
        console.log('rack by room'+$("#id_server_room").val());
        ajax_request_racks_by_room($("#id_server_room").val());
    });

    $("#id_is_physical").change(function(){
        console.log("changed");
        var element = $("#tr_id_server_room");
        if (element.is(":visible")){
            element.hide();
        }else if(element.is(":hidden")) {
            element.show();
        }
    });
    if (!is_physical){
        for (field of vm_fields_to_hide){
            $(field).hide();
        }
    }
});

function ajax_request_rooms_by_territory(territory_id){
    $.ajax({
        url: "{% url 'test_ajax' %}",
        type: 'GET',
        data: {'model':'room','territory': territory_id},
        dataType: "json",
        success: function(resp){
            $("#id_server_room").empty();
            $.each(resp, function(idx, obj) {
                if(obj.pk==room_id){
                    $("#id_server_room").append($('<option></option>').attr('value', obj.pk).attr('selected','selected').text(obj.fields.name));
                }else{
                    $("#id_server_room").append($('<option></option>').attr('value', obj.pk).text(obj.fields.name));
                }
                });
            ajax_request_racks_by_room($("#id_server_room").val());
        },
        error: function(jqXHR, textStatus, errorThrown) {
            alert(errorThrown+'rooms by ter'+territory_id);
        }
    });
}

function ajax_request_racks_by_room(room_id){
     $.ajax({
        url: "{% url 'test_ajax' %}",
        type: 'GET',
        data: {'model':'rack','room': room_id},
        dataType: "json",
        success: function(resp){
            $("#id_server_rack").empty();
            $.each(resp, function(idx, obj) {
                if(obj.pk==rack_id){
                    $("#id_server_rack").append($('<option></option>').attr('value', obj.pk).attr('selected','selected').text(obj.fields.name));
                }else{
                    $("#id_server_rack").append($('<option></option>').attr('value', obj.pk).text(obj.fields.name));
                }
                });
        },
        error: function(jqXHR, textStatus, errorThrown) {
            alert(errorThrown+'racks by room'+room_id);
        }
    });
}



    </script>
</head>

<p style="text-align:right;">Пользователь: {{ user.get_username }}. <a
        href="/admin/logout/?next=/servers/list">выйти</a></p>

{% comment %}
{{form.fields_to_hide}}
{{ form.server_is_physical|negate }}
{% endcomment %}

<form method="post">
    {% csrf_token %}

    <table>
        {% for field in form %}


        <tr id="tr_id_{{field.name}}">
            <th>{{ field.label}}</th>

            <th>{{ field }}</th>
            {% for error in field.errors %}
            <th><font color="red">{{error}}</font></th>
            {% endfor %}

        </tr>

        {% endfor %}
        <tr>
            <th colspan="2"><input type="submit" value="Submit"></th>
        </tr>
    </table>

</form>
</html>